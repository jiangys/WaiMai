<?xml version="1.0"?>
<sqlMap xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" namespace="FoodMenu">
  <alias>
    <typeAlias alias="FoodMenu" type="WHTR.WaiMai.Contracts.Models.FoodMenu, WHTR.WaiMai.Contracts" />
    <typeAlias alias="FoodMenuViewModel" type="WHTR.WaiMai.Contracts.ViewModels.FoodMenuViewModel, WHTR.WaiMai.Contracts" />
  </alias>
  <resultMaps>
    <resultMap id="SelectAllResult" class="FoodMenu">
      <result property="Id" column="Id" />
      <result property="FoodMenuCategoryId" column="FoodMenuCategoryId" />
      <result property="MenuName" column="MenuName" />
      <result property="Price" column="Price" />
      <result property="CreateDate" column="CreateDate" />
      <result property="Creator" column="Creator" />
      <result property="EditDate" column="EditDate" />
      <result property="Editor" column="Editor" />
      <result property="IsDel" column="IsDel" />
      <result property="Version" column="Version" />
    </resultMap>
  </resultMaps>
  <statements>

    <!--查询餐厅列表-->
    <select id="qryFoodMenu" resultClass="FoodMenuViewModel" >
      SELECT
      fm.Id,
      fm.MenuName,
      fm.FoodMenuCategoryId,
      fm.Price,
      fmc.CName,
      r.RestaurantName
      FROM FoodMenu AS fm
      INNER JOIN FoodMenuCategory AS fmc ON fm.FoodMenuCategoryId=fmc.Id
      INNER JOIN Restaurant AS r ON r.Id = fmc.RestaurantId
      WHERE fm.IsDel=0
    </select>

    <select id="qryFoodMenuByRestaurantId" resultClass="FoodMenuViewModel" parameterclass="int">
      SELECT
      fm.Id,
      fm.MenuName,
      fm.FoodMenuCategoryId,
      fm.Price,
      fmc.CName,
      r.RestaurantName,
      Sum(o.TotalCount) TotalCount
      FROM FoodMenu AS fm
      INNER JOIN FoodMenuCategory AS fmc ON fm.FoodMenuCategoryId=fmc.Id
      INNER JOIN Restaurant AS r ON r.Id = fmc.RestaurantId
      LEFT JOIN [Order] AS o ON fm.Id=o.FoodMenuId AND o.IsDel=0
      WHERE fm.IsDel=0 AND r.Id=#value#
      GROUP BY fm.Id,fm.MenuName,fm.FoodMenuCategoryId,fm.Price,fmc.CName,r.RestaurantName
    </select>

    <select id="qryFoodMenuById" resultMap="SelectAllResult" resultClass="FoodMenu" parameterclass="int">
      select * from FoodMenu where ID = #value#
    </select>

    <insert id="insFoodMenu" parameterClass="FoodMenu">
      insert into FoodMenu(FoodMenuCategoryId,MenuName,Price,CreateDate,Creator,EditDate,Editor,IsDel,Version)
      values (#FoodMenuCategoryId#,#MenuName#,#Price#,#CreateDate#,#Creator#,#EditDate#,#Editor#,#IsDel#,#Version#)
      <selectKey  type="post" resultClass="int" property="Id">
        SELECT CAST(@@IDENTITY as int) as Id
      </selectKey>
    </insert>

    <update id ="updFoodMenu" parameterClass="FoodMenu">
      UPDATE FoodMenu
      SET
      FoodMenuCategoryId = #FoodMenuCategoryId#,
      MenuName = #MenuName#,
      Price = #Price#,
      EditDate = GETDATE(),
      Editor = 'sys'
      WHERE Id=#Id#
    </update>


    <delete id="delFoodMenu" parameterclass="int">
      UPDATE FoodMenu
      SET IsDel = 1
      WHERE Id=#value#
    </delete>


  </statements>
</sqlMap>